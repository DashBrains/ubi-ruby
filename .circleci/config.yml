version: 2.1

jobs:
  build_and_publish:
    docker:
      - image: cimg/base:stable
    parameters:
      ruby_version:
        type: string
      container_base:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Prepare Docker
          command: |
            docker context create buildx-build
            docker buildx create --use buildx-build
      - run:
          name: Build docker image
          command: |
            export DOCKER_CLI_EXPERIMENTAL=enabled
            docker buildx build \
              --platform linux/amd64 \
              --build-arg IMAGE=<< parameters.container_base >> \
              --build-arg RUBY_BERSION=<< parameters.ruby_version >> \
              --tag app .
      - run:
          name: Publish to Github Container Registry
          command: |
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin
            docker tag app ghcr.io/dashbrains/<< parameters.container_base >>/ruby:<< parameters.ruby_version >>  
            docker push ghcr.io/dashbrains/<< parameters.container_base >>/ruby:<< parameters.ruby_version >>       

workflows:
  build_and_publish:
    jobs:
      - build_and_publish:
          matrix:
            parameters:
              ruby_version: ['3.2.2', '3.1.4', '3.0.6']
              container_base: ['ubi9', 'ubi8']